// Quorum Meeting Recorder - Database Schema
// Multi-tenant meeting recording and management system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ADMIN   // Full organization access
  MEMBER  // Can create and manage meetings
  VIEWER  // Read-only access
}

enum Platform {
  TEAMS
  SLACK
  YOUTUBE
}

enum MeetingStatus {
  PENDING     // Scheduled, not started
  RECORDING   // Currently recording
  PROCESSING  // Recording complete, processing artifacts
  READY       // All artifacts ready
  FAILED      // Recording or processing failed
}

enum EncodingStatus {
  PENDING     // Waiting to encode
  PROCESSING  // Currently encoding
  READY       // Encoding complete
  FAILED      // Encoding failed
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users                User[]
  meetings             Meeting[]
  botAccounts          BotAccount[]
  recordings           Recording[]
  auditLogs            AuditLog[]
  webhooks             Webhook[]
  streamConfigs        StreamConfig[]
  calendarIntegrations CalendarIntegration[]
  emailInvitations     EmailInvitation[]

  @@index([slug])
  @@map("organizations")
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String
  organizationId String
  role           UserRole @default(MEMBER)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  auditLogs    AuditLog[]

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

model BotAccount {
  id             String   @id @default(cuid())
  organizationId String
  platform       Platform
  credentials    Json     // Encrypted authentication state (tokens, cookies, etc.)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  meetings     Meeting[]

  @@index([organizationId])
  @@index([platform])
  @@map("bot_accounts")
}

model Meeting {
  id             String        @id @default(cuid())
  organizationId String
  botAccountId   String?
  platform       Platform
  url            String
  scheduledStart DateTime
  scheduledEnd   DateTime?
  duration       Int?          // Duration in minutes (nullable until recording complete)
  status         MeetingStatus @default(PENDING)
  containerId    String?       // Docker container ID for active recording
  error          String?       // Error message if status is FAILED
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  botAccount       BotAccount?       @relation(fields: [botAccountId], references: [id], onDelete: SetNull)
  recording        Recording?
  streamConfigs    StreamConfig[]
  calendarEvents   CalendarEvent[]
  emailInvitations EmailInvitation[]

  @@index([organizationId])
  @@index([status])
  @@index([scheduledStart])
  @@index([platform])
  @@index([containerId])
  @@map("meetings")
}

model Recording {
  id                String          @id @default(cuid())
  meetingId         String          @unique
  organizationId    String
  rawVideoUrl       String?         // S3/storage URL for raw recording
  encodedVideoUrl   String?         // S3/storage URL for encoded video
  harFileUrl        String?         // S3/storage URL for HAR file (network logs)
  rawVideoSize      BigInt?         // Size in bytes
  encodedVideoSize  BigInt?         // Size in bytes
  encodingStatus    EncodingStatus  @default(PENDING)
  encodingError     String?         // Error message if encoding failed
  metadata          Json?           // Participant info, meeting metadata, etc.
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  deletedAt         DateTime?       // Soft delete timestamp

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  meeting      Meeting      @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([encodingStatus])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("recordings")
}

model AuditLog {
  id             String   @id @default(cuid())
  organizationId String
  userId         String?  // Nullable for system actions
  action         String   // e.g., "meeting.created", "recording.deleted"
  entity         String   // e.g., "Meeting", "Recording"
  entityId       String   // ID of the affected entity
  changes        Json?    // Before/after changes or action details
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================================================
// WEBHOOKS - HTTP callbacks for external service integration
// ============================================================================

enum WebhookEvent {
  MEETING_STARTED       // Meeting recording has started
  MEETING_COMPLETED     // Meeting recording completed successfully
  MEETING_FAILED        // Meeting recording failed
  RECORDING_READY       // Recording file is ready for download
  ENCODING_STARTED      // Video encoding has started
  ENCODING_COMPLETED    // Video encoding completed
  ENCODING_FAILED       // Video encoding failed
  STREAM_CHUNK_READY    // Real-time stream chunk available
}

model Webhook {
  id             String         @id @default(cuid())
  organizationId String
  name           String         // Human-readable name
  url            String         // Callback URL
  secret         String         // HMAC secret for signature verification
  events         WebhookEvent[] // Events to subscribe to
  isActive       Boolean        @default(true)
  headers        Json?          // Custom headers to include in requests
  retryCount     Int            @default(3)  // Max retry attempts
  timeoutMs      Int            @default(30000) // Request timeout
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveries   WebhookDelivery[]

  @@index([organizationId])
  @@index([isActive])
  @@map("webhooks")
}

model WebhookDelivery {
  id             String   @id @default(cuid())
  webhookId      String
  event          WebhookEvent
  payload        Json     // The data sent
  responseStatus Int?     // HTTP status code received
  responseBody   String?  // Response body (truncated)
  error          String?  // Error message if failed
  duration       Int?     // Request duration in ms
  attempt        Int      @default(1) // Current attempt number
  success        Boolean  @default(false)
  createdAt      DateTime @default(now())

  // Relations
  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([event])
  @@index([success])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

// ============================================================================
// STREAMING - Real-time content streaming configuration
// ============================================================================

enum StreamType {
  HTTP_POST      // POST chunks to an HTTP endpoint
  WEBSOCKET      // Stream via WebSocket connection
  S3_MULTIPART   // Stream directly to S3-compatible storage
}

enum StreamFormat {
  WEBM_CHUNK     // Raw WebM video chunks
  AUDIO_ONLY     // Audio-only stream (for transcription)
  METADATA       // Metadata updates only (participants, events)
}

model StreamConfig {
  id             String       @id @default(cuid())
  organizationId String
  meetingId      String?      // Optional: specific meeting, null = org default
  name           String       // Human-readable name
  type           StreamType
  format         StreamFormat
  url            String       // Destination URL/endpoint
  secret         String?      // Auth secret/token
  headers        Json?        // Custom headers
  chunkIntervalMs Int         @default(5000)  // How often to send chunks (ms)
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  meeting      Meeting?     @relation(fields: [meetingId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([meetingId])
  @@index([isActive])
  @@map("stream_configs")
}

// ============================================================================
// CALENDAR INTEGRATION - iCal, Google Calendar, Outlook
// ============================================================================

enum CalendarProvider {
  ICAL         // iCal file/URL
  GOOGLE       // Google Calendar API
  OUTLOOK      // Microsoft Outlook/365 API
}

enum CalendarEventStatus {
  PENDING      // Not yet processed
  SCHEDULED    // Meeting scheduled for recording
  SKIPPED      // Event skipped (not a meeting)
  COMPLETED    // Recording completed
  FAILED       // Failed to record
}

model CalendarIntegration {
  id             String           @id @default(cuid())
  organizationId String
  name           String           // Human-readable name
  provider       CalendarProvider
  calendarUrl    String?          // iCal URL (for ICAL provider)
  accessToken    String?          // OAuth access token (encrypted)
  refreshToken   String?          // OAuth refresh token (encrypted)
  tokenExpiry    DateTime?        // When access token expires
  calendarId     String?          // Specific calendar ID (for multi-calendar accounts)
  syncInterval   Int              @default(300) // How often to sync (seconds)
  lastSyncAt     DateTime?
  isActive       Boolean          @default(true)
  autoSchedule   Boolean          @default(false) // Auto-create meetings from events
  filterKeywords String[]         // Only process events with these keywords
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  events       CalendarEvent[]

  @@index([organizationId])
  @@index([provider])
  @@index([isActive])
  @@map("calendar_integrations")
}

model CalendarEvent {
  id                    String              @id @default(cuid())
  calendarIntegrationId String
  organizationId        String
  externalId            String              // Event ID from calendar provider
  title                 String
  description           String?
  location              String?             // Could be meeting URL
  meetingUrl            String?             // Extracted meeting URL
  platform              Platform?           // Detected platform
  startTime             DateTime
  endTime               DateTime
  organizer             String?             // Organizer email/name
  attendees             Json?               // List of attendees
  status                CalendarEventStatus @default(PENDING)
  meetingId             String?             // Linked meeting (if scheduled)
  error                 String?             // Error message if failed
  rawData               Json?               // Original event data
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  calendarIntegration CalendarIntegration @relation(fields: [calendarIntegrationId], references: [id], onDelete: Cascade)
  meeting             Meeting?            @relation(fields: [meetingId], references: [id], onDelete: SetNull)

  @@unique([calendarIntegrationId, externalId])
  @@index([organizationId])
  @@index([startTime])
  @@index([status])
  @@index([meetingId])
  @@map("calendar_events")
}

// ============================================================================
// EMAIL INVITATIONS
// ============================================================================

enum EmailInvitationStatus {
  PENDING      // Waiting to be processed
  PROCESSED    // Meeting extracted and scheduled
  INVALID      // Not a valid meeting invitation
  FAILED       // Failed to process
}

model EmailInvitation {
  id             String                @id @default(cuid())
  organizationId String
  fromAddress    String
  toAddress      String
  subject        String
  bodyText       String?
  bodyHtml       String?
  meetingUrl     String?               // Extracted meeting URL
  platform       Platform?             // Detected platform
  scheduledStart DateTime?
  scheduledEnd   DateTime?
  icsAttachment  String?               // Raw iCal attachment content
  status         EmailInvitationStatus @default(PENDING)
  meetingId      String?               // Linked meeting (if created)
  error          String?
  rawHeaders     Json?                 // Email headers
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  meeting      Meeting?     @relation(fields: [meetingId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([status])
  @@index([meetingId])
  @@index([createdAt])
  @@map("email_invitations")
}
